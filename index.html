<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDM Night: Flappy Glow</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<script async src="//www.instagram.com/embed.js"></script>
<style>
/* Your CSS here (same as before, omitted for brevity) */
</style>
</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4">

<div class="relative w-full max-w-lg lg:max-w-md xl:max-w-lg aspect-[3/4] flex items-center justify-center">
    <div id="score" class="absolute top-4 left-1/2 -translate-x-1/2 text-6xl font-bold text-glow z-10">0</div>
    <div id="highScoreDisplay" class="absolute top-5 left-5 text-lg font-bold text-glow-secondary z-10">HIGH SCORE: 0</div>
    <button id="muteButton" class="absolute top-5 right-5 z-10 bg-black bg-opacity-30 p-2 rounded-full">ðŸ”Š</button>
    <canvas id="gameCanvas"></canvas>
</div>

<!-- Pre-Game Submission Modal -->
<div id="preGameModal" class="absolute inset-0 z-20 flex items-center justify-center">
    <div class="text-center p-8 rounded-2xl max-w-md mx-4">
        <h1 class="text-5xl md:text-6xl font-bold text-glow mb-4">FLAPPY GLOW</h1>
        <p class="text-xl text-glow-secondary mb-2">EDM NIGHT</p>
        <input type="text" id="preNameInput" placeholder="ENTER YOUR NAME" class="form-input w-full p-3 rounded-lg text-center text-white placeholder-gray-400 mb-4" maxlength="15">
        <input type="text" id="preRollNumberInput" placeholder="ENTER YOUR ROLL NUMBER (e.g., AB12C345)" class="form-input w-full p-3 rounded-lg text-center text-white placeholder-gray-400 mb-4" maxlength="20">
        <button id="preSubmitButton" class="modal-button text-2xl w-full">SUBMIT & START</button>
    </div>
</div>

<div id="gameOverModal" class="absolute inset-0 z-20 hidden items-center justify-center overflow-y-auto no-scrollbar">
    <div class="text-center p-8 rounded-2xl max-w-lg w-11/12 my-8">
        <h1 class="text-5xl font-bold text-glow-secondary mb-2">GAME OVER</h1>
        <p class="text-2xl mb-4">Your Score: <span id="finalScore" class="font-bold text-glow">0</span></p>

        <div class="bg-purple-900 bg-opacity-50 p-4 rounded-lg border border-purple-500 mb-6">
             <h2 class="text-2xl font-bold text-glow mb-2">FIND OUT WHO THE EDM ARTIST IS</h2>
             <p>The EDM Night artist reveal is on 15th October. Top 3 on this game will get special prizes!</p>
        </div>

        <div id="submission-section">
            <div class="flex flex-col gap-4 items-center">
                 <input type="text" id="nameInput" placeholder="ENTER YOUR NAME" class="form-input w-full p-3 rounded-lg text-center text-white placeholder-gray-400" maxlength="15">
                 <input type="text" id="rollNumberInput" placeholder="ENTER YOUR ROLL NUMBER (e.g., AB12C345)" class="form-input w-full p-3 rounded-lg text-center text-white placeholder-gray-400" maxlength="20">
                 <button id="submitScoreButton" class="modal-button w-full">SUBMIT TO LEADERBOARD</button>
                 <button id="playAgainButton1" class="bg-transparent border border-gray-500 text-gray-300 p-2 rounded-lg w-full hover:bg-gray-700 hover:text-white transition mt-4">PLAY AGAIN</button>
            </div>
        </div>
        
        <div id="post-submission-section" class="hidden">
             <div class="flex flex-col sm:flex-row gap-4 w-full mb-6">
                <button id="viewLeaderboardButton" class="modal-button w-full">VIEW LEADERBOARD</button>
                <button id="playAgainButton2" class="modal-button w-full bg-transparent border border-cyan-400 text-cyan-400 hover:bg-cyan-400 hover:text-black">PLAY AGAIN</button>
             </div>
             <h3 class="text-lg font-bold text-glow mb-4">GET HYPED!</h3>
             <div id="hypeReelContainer" class="max-w-sm mx-auto">
                <!-- Instagram embed will load here -->
             </div>
        </div>
    </div>
</div>

<!-- Leaderboard, Alert, Confirm modals same as before -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, updateDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Init ---
let db, auth, userId;
const appId = 'flappy-glow-default'; // Replace with your appId
let latestDocId = null;

// Initialize Firebase
const firebaseConfig = { /* your config JSON */ };
const app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);

// Anonymous Sign-In
async function initUser() {
    if (!userId) {
        const cred = await signInAnonymously(auth);
        userId = cred.user.uid;
    }
}

// --- DOM Elements ---
const preGameModal = document.getElementById('preGameModal');
const preNameInput = document.getElementById('preNameInput');
const preRollNumberInput = document.getElementById('preRollNumberInput');
const preSubmitButton = document.getElementById('preSubmitButton');

const startModal = document.getElementById('startModal');
const gameOverModal = document.getElementById('gameOverModal');
const submissionSection = document.getElementById('submission-section');
const postSubmissionSection = document.getElementById('post-submission-section');
const nameInput = document.getElementById('nameInput');
const rollNumberInput = document.getElementById('rollNumberInput');
const submitScoreButton = document.getElementById('submitScoreButton');
const finalScoreDisplay = document.getElementById('finalScore');
const hypeReelContainer = document.getElementById('hypeReelContainer');
const playAgainButton1 = document.getElementById('playAgainButton1');
const playAgainButton2 = document.getElementById('playAgainButton2');

// --- Custom Alert/Confirm Functions (same as before) ---
function showAlert(msg) { alert(msg); }
function showConfirm(msg) { return Promise.resolve(confirm(msg)); }

// --- Game Setup ---
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
let animationFrameId, canvasWidth, canvasHeight, player, pipes, score, isGameOver, gameSpeed, gameStarted;
const GRAVITY = 0.3, LIFT = -6, PIPE_WIDTH = 50, PIPE_GAP = 180, PIPE_SPACING = 300;
const INITIAL_GAME_SPEED = 3, MAX_GAME_SPEED = 7, SCORE_DIFFICULTY_INTERVAL = 3;

// Player, Pipe, Particle classes same as your code
// initGame, handlePipes, gameLoop, gameOver, startGame functions same as before

// --- Pre-Game Submission Handler ---
preSubmitButton.addEventListener('click', async () => {
    const name = preNameInput.value.trim();
    const roll = preRollNumberInput.value.trim().toUpperCase();

    if (!name || !roll) { showAlert("Please enter name and roll number."); return; }
    if (!/^[A-Z]{2}\d{2}[A-Z]\d{3}$/.test(roll)) { showAlert("Invalid roll number format."); return; }

    await initUser();

    const userDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId);
    const userDocSnap = await getDoc(userDocRef);
    if (!userDocSnap.exists()) {
        await setDoc(userDocRef, { name, rollNumber: roll, score: 0, createdAt: serverTimestamp() });
    }

    preGameModal.style.display = 'none';
    startGame(); // Start the game after submission
});

// --- Submit Score Button after game over ---
submitScoreButton.addEventListener('click', async () => {
    const name = nameInput.value.trim();
    const roll = rollNumberInput.value.trim().toUpperCase();

    if (!name || !roll) { showAlert("Please fill in name and roll number."); return; }
    if (!/^[A-Z]{2}\d{2}[A-Z]\d{3}$/.test(roll)) { showAlert("Invalid roll number."); return; }

    await initUser();

    const userDocRef = doc(db, `/artifacts/${appId}/public/data/leaderboard`, userId);
    const userDocSnap = await getDoc(userDocRef);

    if (userDocSnap.exists()) {
        const oldScore = userDocSnap.data().score || 0;
        if (score > oldScore) await updateDoc(userDocRef, { score, createdAt: serverTimestamp() });
        latestDocId = userId;
    } else {
        const confirmed = await showConfirm("You can only set Name/Roll once. Proceed?");
        if (!confirmed) return;
        await setDoc(userDocRef, { name, rollNumber: roll, score, createdAt: serverTimestamp() });
        latestDocId = userId;
    }

    submissionSection.style.display = 'none';
    postSubmissionSection.classList.remove('hidden');

    hypeReelContainer.innerHTML = `<blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/reel/C2Kq_D8y7fS/" data-instgrm-version="14"></blockquote>`;
    if (window.instgrm) window.instgrm.Embeds.process();
});

// --- Play Again Buttons ---
[playAgainButton1, playAgainButton2].forEach(btn => {
    btn.addEventListener('click', () => {
        postSubmissionSection.classList.add('hidden');
        submissionSection.style.display = 'flex';
        gameOverModal.style.display = 'none';
        startGame();
    });
});

// --- Initialize Game ---
function startGame() {
    initAudio();
    initGame();
    startModal?.style?.display = 'none';
    gameOverModal.style.display = 'none';
    gameLoop();
}

</script>
</body>
</html>
